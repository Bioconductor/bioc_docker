# DO NOT EDIT FILES CALLED 'Dockerfile'; they are automatically
# generated. Edit 'Dockerfile.in' and generate the 'Dockerfile'
# with the 'rake' command.

# The suggested name for this image is: <%= image_name %>.
FROM <%= parent %>

MAINTAINER maintainer@bioconductor.org

# nuke cache dirs before installing pkgs; tip from Dirk E fixes broken img
RUN  rm -f /var/lib/dpkg/available && rm -rf  /var/cache/apt/*

# same set of packages for both devel and release
RUN apt-get update && \
	apt-get -y --no-install-recommends install --fix-missing \
	gdb \
	libxml2-dev \
	python-pip \
	libz-dev \
	libmariadb-client-lgpl-dev \
	&& rm -rf /var/lib/apt/lists/*

<% if is_devel %>

## TODO: It is worth investigating why we need to install any of these
## texlive packages.
<% if use_r_devel %>
RUN apt-get update && \
	apt-get -y --no-install-recommends install --fix-missing --fix-broken \
	texlive \
	texlive-latex-extra \
	&& rm -rf /var/lib/apt/lists/*
<% end %>

#<% if !use_r_devel %>
RUN apt-get update && \
	apt-get -y --no-install-recommends install --fix-missing --fix-broken \
	texlive \ 
	texlive-latex-extra \
	&& rm -rf /var/lib/apt/lists/*
#<% end %>
<% end %>

<% if is_devel %>
# issues with '/var/lib/dpkg/available' not found
# this will recreate
RUN dpkg --clear-avail
<% end %>

ADD install.R /tmp/

RUN R -f /tmp/install.R

# Add bioc user as requested
RUN useradd -ms /bin/bash -d /home/bioc bioc
RUN echo "bioc:bioc" | chpasswd && adduser bioc sudo
USER bioc
RUN mkdir -p /home/bioc/R/library && \
        echo "R_LIBS=/usr/local/lib/R/host-site-library:~/R/library" | cat > /home/bioc/.Renviron 
USER root

RUN echo "R_LIBS=/usr/local/lib/R/host-site-library:\${R_LIBS}" > /usr/local/lib/R/etc/Renviron.site
RUN echo "R_LIBS_USER=''" >> /usr/local/lib/R/etc/Renviron.site
RUN echo "options(defaultPackages=c(getOption('defaultPackages'),'BiocManager'))" >> /usr/local/lib/R/etc/Rprofile.site
